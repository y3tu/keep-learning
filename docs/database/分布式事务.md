### 分布式事务

#### 事务定义

事务提供一种机制将一个活动涉及的所有操作都纳入到一个不可分割的执行单元，组成事务的所有操作只有在操作均正常执行的情况下才能提交，只要其中任一操作执行失败，都会导致整个事务的回滚。简单来说，`要么做，要么不做`。

#### 事务的四大特性：`ACID`

* **A（Atomic）**：原子性，构成事物的所有操作，要么全部执行完成，要么全部不执行，不能出现部分成功部分失败的情况。

* **C（Consistency）**：一致性，在事务执行前后，数据库的一致性约束没有被破坏。一旦所有事务动作完成，事务就被提交，数据和资源处于一种满足业务规则的一致性状态中。比如去商店买东西，我向商店老板付了钱，我这边扣除了100，而老板增加了100，这种就称为一致性。

* **I（Isolation）**：隔离性，数据库中的事务一般都是并发的，隔离性是指并发的两个事务互不干扰，一个事务不能看到其他事务运行过程的中间状态，通过配置事务隔离级别可以避免脏读、幻读、不可重复读等问题。

* **D（Durability）**：持久性，事务完成之后，该事务对数据的更改会持久化到数据库中，并且不会被回滚。

#### 微服务

微服务架构是将传统的单体拆分成多个服务，然后多个服务之间相互配合，来完成业务需求。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7908b553c1ec47048bd63a304aee5064~tplv-k3u1fbpfcp-watermark.awebp)

分布式事务就是指事务的参与者，支持事务的服务器，资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上。

微服务中的 **CAP理论**

* **C（Consistency）**：一致性。服务A、B、C三个节点都存储了用户数据，三个节点的数据都需要保持同一时刻数据一致性

* **A（Availability）**：可用性。服务A、B、C三个节点，其中一个节点如果宕机了，不能影响整个集群对外提供服务。

* **P（Partition Tolerance）**：分区容错性就是允许系统通过网络协同工作，分区容错性要解决由于网络分区导致数据的不完整及无法访问等问题。

**CAP** 目前来说无法都兼备，因此当前微服务策略中要么 `CA`，要么`CP`，不然就是`AP`。而这个时候又有一个理论出现了，那就是 **BASE理论** 。它是用来对 **CAP理论** 进行一些补充。

- **BA（Basically Available）**：基本可用
- **S（Soft State）**：软状态
- **E（Eventually Consistent）**：最终一致性

这个理论的核心思想便是：如果我们无法做到强一致性，那么每个应用都应该根据自身的业务特点，采用适当的方式来使系统达到最终一致性。

#### 分布式事务场景

场景1：虽然是单体的架构服务，但是由于在分库的情况下，依然会导致分布式事务的情况。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/93ce8c3ae4be4a9c915b50af507240da~tplv-k3u1fbpfcp-watermark.awebp)

场景2：分布式架构下，两个服务之间相互调用，虽然使用的是同一个数据库，但是还会出现分布式事务。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e0ff493426c84dd5b7a6835b0e79aa0e~tplv-k3u1fbpfcp-watermark.awebp)

场景3：分布式架构下，两个服务之间相互调用，使用不同的数据库，这种情况肯定会出现分布式事务。

#### 分布式事务解决方法

##### 全局事务(两阶段提交2PC)

